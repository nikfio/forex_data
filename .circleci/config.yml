# Python CircleCI 2.1 configuration file
version: 2.1

defaults:
  &defaults
  working_directory: ~/repo

read_cache:
  &read_cache
  keys:
    - v1-dependencies-{{ checksum "poetry.lock" }}
    - v1-dependencies-

store_cache:
  &store_cache
  paths:
    - ./repo
  key: v1-dependencies-{{ checksum "poetry.lock" }}

install_poetry:
  &install_poetry
  name: install poetry
  command: pip install poetry

install_deps:
  &install_deps
  name: install dependencies
  command: poetry install

run_tests:
  &run_tests
  name: run tests
  command: |
    mkdir -p test-results
    poetry run pytest --flake8 -vv --junitxml=test-results/junit.xml 2>&1 | tee test-results/console_output.log

run_profiling:
  &run_profiling
  name: run profiling with pyinstrument
  command: |
    mkdir -p test-results/profiling
    echo "Profiling test suite execution..."
    poetry run pyinstrument --renderer html \
      --outfile test-results/profiling/full_test_suite.html \
      -m pytest --flake8 -vv
    poetry run pyinstrument --renderer json \
      --outfile test-results/profiling/full_test_suite.json \
      -m pytest --flake8 -vv
    echo "Profiling completed. Reports saved to test-results/profiling/"
  
jobs:
  py312:
    <<: *defaults
    docker:
      - image: cimg/python:3.12.12
        environment:
          DATABASE_URL: ${DATABASE_URL}
          API_KEY: ${API_KEY}
    steps:
      - checkout
      - run: *install_poetry
      - restore_cache: *read_cache
      - run: *install_deps
      - save_cache: *store_cache
      - run: *run_tests
      - run: *run_profiling
      - run:
          name: collect application logs
          when: always
          command: |
            mkdir -p test-results/log
            find ~/.database -name "*.log" -type f -exec cp {} test-results/log/ \; 2>/dev/null || true
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results
  
workflows:
  version: 1
  unit-tests:
    jobs:
      - py312:
          filters:
            branches:
              only:
                - master
